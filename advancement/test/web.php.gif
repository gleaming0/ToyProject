<?php
   @session_start();
   header("Content-Type: text/html; charset=UTF-8");
   include ( './common.php' );

   $mode = $_REQUEST["mode"];
   $db_conn = mysql_conn();
   
   if($mode == "write") {
      $title = $_POST["title"];
      $id = $_SESSION["id"];
      $writer = $_SESSION["name"];
      $password = $_POST["password"];
      $content = $_POST["content"];
      $secret = $_POST["secret"];
      $uploadFile = ""; 
		  
      echo $title."<br>";
      echo $id."<br>";
      echo $writer."<br>";
      echo $password."<br>";
      echo $content."<br>";
      echo $secret."<br>";
      exit;
      

      if(empty($title) || empty($password) || empty($content)) {
         echo "<script>alert('빈칸이 존재합니다.');history.back(-1);</script>";
         exit();
      }
      
      if(!empty($_FILES["userfile"]["name"])) {
         $uploadFile = $_FILES["userfile"]["name"];
         $uploadPath = "{$upload_path}/{$uploadFile}";
      

         #. medium단계(단순 확장자로만 파일 필터링)
         $userfile_name = $_FILES[ 'userfile' ][ 'name' ];
         $userfile_type = $_FILES[ 'userfile' ][ 'type' ];
         $userfile_size = $_FILES[ 'userfile' ][ 'size' ];   
         echo "<hr>";
         echo $userfile_name."<br>";
         echo $userfile_type."<br>";;
         echo $userfile_size."<br>";;
         echo "<hr>";
         
         if( ( $userfile_type == "image/jpeg" || $userfile_type == "image/png" ) &&
            ( $userfile_size < 100000 ) ) {

            // Can we move the file to the upload folder?
            $uploadFile = $_FILES["userfile"]["name"];
            $uploadPath = "{$upload_path}/{$uploadFile}";
            
            if(!(@move_uploaded_file($_FILES['userfile']['tmp_name'], $uploadPath))) {
               echo("<script>alert('파일 업로드를 실패 하셨습니다.');history.back(-1);</script>");
               exit;
            } else {
               if($secret == "on") {
                  $secret = "y";
               } else {
                  $secret = "n";
               }

               $content = str_replace("\r\n", "<br>", $content);
               
               $query = "insert into {$tb_name}(title, id, writer, password, content, file, secret, regdate) values('{$title}', '{$id}', '{$writer}', '{$password}', '{$content}', '{$uploadFile}', '{$secret}', now())";
               $db_conn->query($query);
               echo ("<script>alert('파일 업로드 성공');</script>");
            }
         }   else {
            // Invalid file
            $html .= '<pre>Your image was not uploaded. We can only accept JPEG or PNG images.</pre>';
            echo $html;
         }
   
      }
         #. high단계






         #. impossible 단계
         /*
         $uploadFile = $_FILES["userfile"]["name"];
         $uploadPath = "{$upload_path}/{$uploadFile}";
         
         if(!(@move_uploaded_file($_FILES['userfile']['tmp_name'], $uploadPath))) {
            echo("<script>alert('파일 업로드를 실패 하셨습니다.');history.back(-1);</script>");
            exit;
         }
         */
      
   } else if($mode == "modify") {
      $idx = $_POST["idx"];
      $title = $_POST["title"];
      $password = $_POST["password"];
      $content = $_POST["content"];
      $secret = $_POST["secret"];
      $uploadFile = $_POST["oldfile"];

      if(empty($idx) || empty($title) || empty($password) || empty($content)) {
         echo "<script>alert('빈칸이 존재합니다.');history.back(-1);</script>";
         exit();
      }

      # Password Check Logic
      $query = "select * from {$tb_name} where idx={$idx} and password='{$password}'";
      $result = $db_conn->query($query);
      $num = $result->num_rows;

      if($num == 0) {
         echo "<script>alert('패스워드가 일치하지 않습니다.');history.back(-1);</script>";
         exit();
      }

      if(!empty($_FILES["userfile"]["name"])) {
         #. medium단계(단순 확장자로만 파일 필터링)
         $userfile_name = $_FILES[ 'userfile' ][ 'name' ];
         $userfile_type = $_FILES[ 'userfile' ][ 'type' ];
         $userfile_size = $_FILES[ 'userfile' ][ 'size' ];   

         if( ( $uploaded_type == "image/jpeg" || $uploaded_type == "image/png" ) &&
            ( $uploaded_size < 100000 ) ) {

            // Can we move the file to the upload folder?
            $uploadFile = $_FILES["userfile"]["name"];
            $uploadPath = "{$upload_path}/{$uploadFile}";
            
            if(!(@move_uploaded_file($_FILES['userfile']['tmp_name'], $uploadPath))) {
               echo("<script>alert('파일 업로드를 실패 하셨습니다.');history.back(-1);</script>");
               exit;
            } else {
               echo ("<script>alert('파일 업로드 성공');</script>");
            }
         }
         else {
            // Invalid file
            $html .= '<pre>Your image was not uploaded. We can only accept JPEG or PNG images.</pre>';
         }





         #. high단계


         #. impossible 단계
         /*
         $uploadFile = $_FILES["userfile"]["name"];
         $uploadPath = "{$upload_path}/{$uploadFile}";
         
         if(!(@move_uploaded_file($_FILES['userfile']['tmp_name'], $uploadPath))) {
            echo("<script>alert('파일 업로드를 실패 하셨습니다.');history.back(-1);</script>");
            exit;
         }
         */
      }
      
      if($secret == "on") {
         $secret = "y";
      } else {
         $secret = "n";
      }
      
      $content = str_replace("\r\n", "<br>", $content);
      
      $query = "update {$tb_name} set title='{$title}', content='{$content}', file='{$uploadFile}', secret='{$secret}', regdate=now() where idx={$idx}";
      $db_conn->query($query);
   } else if($mode == "delete") {
      $idx = $_POST["idx"];
      $password = $_POST["password"];
      
      # Password Check Logic
      $query = "select * from {$tb_name} where idx={$idx} and password='{$password}'";
      $result = $db_conn->query($query);
      $num = $result->num_rows;

      if($num == 0) {
         echo "<script>alert('패스워드가 일치하지 않습니다.');history.back(-1);</script>";
         exit();
      }
      
      $query = "delete from {$tb_name} where idx={$idx}";
      $db_conn->query($query);
   }

   //echo "<script>location.href='index.php';</script>";
   $db_conn->close();
?>